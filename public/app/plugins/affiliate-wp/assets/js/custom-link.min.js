window.affWPCustomLink=window.affWPCustomLink||function(t){let i=affWpCustomLinksVars,n={},a={customLink:{},notices:null,noticesTimeout:3e3,init:function(){t(a.ready)},ready:function(){n={$url:t("#affwp-url"),$campaign:t("#affwp-campaign"),$campaignBtn:t("#affwp-generator-toggle-campaign"),$form:t("#affwp-custom-link-generator"),$table:t("#affwp-custom-links-table"),$notices:t("#affwp-generator-submit-notices"),$submitBtn:t("#affwp-generator-submit-btn")},a.events()},events:function(){n.$form.on("submit",a.onSave),n.$table.on("click",".affwp-custom-link",a.onCopy),n.$table.on("click",".affwp-edit-custom-link",a.onEdit),n.$campaign.on("focusout",a.cleanCampaignWhitespaces),n.$campaignBtn.on("click",a.onClickCampaignBtn),a.initializeSubmissionNotices(),a.updateTooltips()},initializeSubmissionNotices:function(){a.notices=tippy(n.$notices.get(0),{content:"",trigger:"manual",placement:"top",animation:"fade",hideOnClick:!1})},updateTooltips:function(){a.initializeButtons(".affwp-tooltip-url-copy:not(.affwp-tooltip-initialized)","click",i.i18n.copied,1e3),a.initializeButtons(".affwp-tooltip-button-copy:not(.affwp-tooltip-initialized)","mouseenter focus",i.i18n.copied,1e3,i.i18n.copy_affiliate_link,!0),a.initializeButtons(".affwp-tooltip-edit:not(.affwp-tooltip-initialized)","mouseenter focus",i.i18n.edit_affiliate_link,0)},initializeButtons:function(t,i,n,e,o=null,u=!1){let s=document.querySelectorAll(t);s.forEach(t=>{let s=tippy(t,{trigger:i,duration:[300,250],hideOnClick:!1,onCreate(t){t.reference.classList.add("affwp-tooltip-initialized")}});t.addEventListener("click",()=>a.handleButtonClick(s,n,e,o,u))})},handleButtonClick:function(t,i,n,a=null,e=!1){t.setContent(i),t.show(),e&&t.setProps({trigger:"manual"}),setTimeout(()=>{t.hide(),e&&t.setProps({trigger:"mouseenter focus"})},n),a&&t.setProps({onHidden(){t.setContent(a),t.setProps({onHidden:null})}})},cleanCampaignWhitespaces:function(){n.$campaign.val(n.$campaign.val().replace(/\s/g,""))},onCopy:function(i){i.preventDefault(),a.copyToClipboard(t(this).closest("tr").data("custom-link-id"))},onEdit:function(e){e.preventDefault();let o=t(this).closest("tr"),u=new URL(o.data("custom-link")),s=new URLSearchParams(u.search),l=s.get("campaign");n.$url.val(o.data("destination-link")).focus(),n.$form.find(".affwp-custom-link-id").val(o.data("custom-link-id")),n.$submitBtn.val(i.i18n.custom_link_btn_update),a.hideCampaign(""),l&&a.showCampaign(l)},onSave:function(t){t.preventDefault(),a.queryCustomLink();let n=a.parseUrl(a.customLink.URL);if(null===n){a.showNotice(i.i18n.invalid_url);return}a.save(n.toString(),a.customLink.campaign,a.customLink.ID)},getTableRowHtml:function(t){let n=i.template;return Object.entries(t).forEach(([t,i])=>{n=n.replace(RegExp(`{{\\b${t}\\b}}`,"g"),i)}),n},save:function(e,o="",u=0){if("string"!=typeof e||!a.isValidUrlString(e)){console.error("Can not save. You must supply a valid url string.");return}t.ajax({type:"POST",url:i.ajax_url,data:{action:"affwp_save_custom_link",nonce:i.nonce,url:e,campaign:o,custom_link_id:u},dataType:"json",beforeSend:function(){a.lockForm(),a.showNotice(i.i18n.saving,"success",0)},success:function(e){if(!e.success){a.showNotice(e.data.message);return}a.customLink.ID=e.data.fields.ID,n.$table.removeClass("affwp-hidden");let o=t(a.getTableRowHtml(e.data.fields));if(e.data.updated?(n.$table.find(`tbody tr[data-custom-link-id="${a.customLink.ID}"]`).replaceWith(o),setTimeout(function(){a.resetForm()},a.noticesTimeout)):(n.$table.find("tbody").prepend(o),a.resetForm()),a.updateTooltips(),navigator&&navigator.clipboard){navigator.clipboard.writeText(o.data("custom-link")).then(()=>{a.showNotice(e.data.updated?i.i18n.successfully_updated_and_copied:i.i18n.successfully_created_and_copied,"success")}).catch(()=>{a.showNotice(e.data.message,"success")});return}a.showNotice(e.data.message,"success")},complete:function(t){(!t.responseJSON||!t.responseJSON.data||!t.responseJSON.data.updated)&&a.unlockForm()}}).fail(function(t){a.showNotice(i.i18n.invalid_request)})},lockForm:function(){n.$campaign.attr("disabled",!0),n.$url.attr("disabled",!0),n.$submitBtn.attr("disabled",!0)},unlockForm:function(){n.$campaign.attr("disabled",!1),n.$url.attr("disabled",!1),n.$submitBtn.attr("disabled",!1)},resetForm:function(){n.$form.find(".affwp-custom-link-id").val(0),n.$submitBtn.val(i.i18n.custom_link_btn_create),n.$url.val(""),a.unlockForm(),a.hideCampaign("")},queryCustomLink:function(){a.customLink={ID:parseInt(n.$form.find('input[type="hidden"].affwp-custom-link-id').val()),affiliateID:parseInt(n.$form.find('input[type="hidden"].affwp-affiliate-id').val()),URL:n.$url.val().toString(),campaign:n.$campaign.val().toString()}},copyToClipboard:function(t){let i=n.$table.find(`tbody tr[data-custom-link-id="${t}"]`);if(!i.length)return;let a=i.find(".affwp-copy-custom-link");!a.hasClass("copied")&&navigator&&navigator.clipboard&&navigator.clipboard.writeText(i.data("custom-link"))},showNotice:function(t,i="error",n=null){n="number"==typeof n?parseInt(n):parseInt(a.noticesTimeout),a.notices.setContent(t),a.notices.show(),n>0&&setTimeout(function(){a.notices.hide()},n)},showCampaign:function(t=null){"string"==typeof t&&n.$campaign.val(t),n.$form.find(".affwp-generator-campaign-text-link-wrap").addClass("affwp-hidden"),n.$form.find(".affwp-campaign-wrap").removeClass("affwp-hidden")},hideCampaign:function(t=null){"string"==typeof t&&n.$campaign.val(t),n.$form.find(".affwp-campaign-wrap").addClass("affwp-hidden"),n.$form.find(".affwp-generator-campaign-text-link-wrap").removeClass("affwp-hidden")},onClickCampaignBtn:function(t){t.preventDefault(),a.showCampaign("")},isValidUrlString:function(t){return/^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(t)},parseUrl:function(t){return"string"!=typeof t?(console.error("Url must be a string."),null):(t=t.trim().replace(/([^:])(\/\/+)/g,"$1/").replace(/ /g,"%20"),a.isValidUrlString(t)?new URL(t):null)}};return a}(jQuery),affWPCustomLink.init();
